- name: Create local user and add to sudo
  hosts: archpi
  remote_user: alarm
  become: yes
  become_method: su
  become_user: root
  ignore_unreachable: yes
  vars:
    ansible_user: alarm
    ansible_ssh_pass: alarm
    ansible_become_pass: root
  tasks:
    - name: LOCAL USER CREATED
      include_tasks: ./tasklists/local-user.yaml
      when: ansible_facts['nodename'] is defined

    - name: Remove previous hard-coded host key
      file:
        state: absent
        path: "{{ item }}"
      with_items:
        - /etc/ssh/ssh_host_ed25519_key
        - /etc/ssh/ssh_host_ed25519_key.pub
      when: ansible_facts['nodename'] is defined

    - name: SSH CONFIGURED
      include_tasks: ./tasklists/ssh.yaml
      when: ansible_facts['nodename'] is defined

    - name: SUDO CONFIGURED
      include_tasks: ./tasklists/sudo.yaml
      when: ansible_facts['nodename'] is defined

- name: Remove previous users
  hosts: archpi
  become: yes
  tasks:
    - name: REMOVE EXISTING USERS
      include_tasks: ./tasklists/remove-default-users.yaml
